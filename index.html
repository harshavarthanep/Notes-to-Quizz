<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExamReady Mobile v6</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --border: #334155;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; padding-bottom: 80px; }
        
        /* Mobile Container */
        .container { padding: 16px; max-width: 800px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        h1 { font-size: 1.5rem; margin: 0; color: var(--primary); }
        p { color: #94a3b8; font-size: 0.9rem; margin: 5px 0 0 0; }

        /* TABS - Horizontal Scroll for Mobile */
        .tabs { 
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px;
            scrollbar-width: none; /* Hide scrollbar Firefox */
        }
        .tabs::-webkit-scrollbar { display: none; /* Hide scrollbar Chrome */ }
        
        .tab-btn { 
            background: var(--card); border: 1px solid var(--border); color: #94a3b8; 
            padding: 10px 16px; border-radius: 20px; white-space: nowrap; font-size: 0.9rem; flex-shrink: 0;
            transition: 0.2s;
        }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Input Zones */
        .input-zone { display: none; animation: fadeIn 0.3s; }
        .input-zone.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        textarea { 
            width: 100%; height: 160px; background: var(--card); color: white; 
            border: 1px solid var(--border); border-radius: 12px; padding: 15px; font-size: 16px; 
        }

        /* CAMERA FIXED */
        .camera-wrapper {
            position: relative; background: black; border-radius: 12px; overflow: hidden;
            aspect-ratio: 3/4; /* Better for mobile portrait */
            margin-bottom: 10px;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        .cam-overlay {
            position: absolute; bottom: 20px; left: 0; width: 100%; display: flex; justify-content: center; gap: 15px;
        }
        .cam-btn {
            background: white; color: black; border: none; width: 50px; height: 50px; border-radius: 50%;
            font-size: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .cam-btn.snap { background: var(--danger); color: white; border: 4px solid rgba(255,255,255,0.3); width: 60px; height: 60px;}

        /* Loader Overlay (Fixed) */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9); z-index: 999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--border); border-top: 4px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Study Area */
        .workspace { display: none; margin-top: 25px; }
        .content-box { 
            background: var(--card); padding: 20px; border-radius: 12px; font-size: 1.1rem; line-height: 1.8; 
            margin-bottom: 20px; border: 1px solid var(--border);
        }
        
        .term { border-bottom: 2px solid var(--primary); color: #a5b4fc; font-weight: 600; padding: 0 2px; }
        .blur-mode .term { background: #475569; color: transparent; border: none; border-radius: 4px; }
        .blur-mode .term.revealed { background: var(--success); color: white; }

        /* Actions Grid */
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-full { grid-column: span 2; background: var(--primary); color: white; padding: 14px; border-radius: 12px; font-weight: bold; border: none; font-size: 1rem; }
        .btn-sec { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 12px; font-weight: 600; }
        .btn-sec:disabled { opacity: 0.5; }

        /* Saved Sessions (Bottom Sheet Style) */
        .saved-section { margin-top: 40px; border-top: 1px solid var(--border); padding-top: 20px; }
        .session-card {
            background: var(--card); padding: 15px; border-radius: 10px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);
        }
        .del-btn { color: var(--danger); padding: 10px; font-size: 1.2rem; }

        /* Quiz UI */
        .quiz-card { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); }
        .option { 
            display: block; width: 100%; padding: 12px; margin-top: 8px; 
            background: var(--bg); border: 1px solid var(--border); color: white; border-radius: 8px; text-align: left;
        }
        .option.correct { border-color: var(--success); background: rgba(16, 185, 129, 0.2); }
        .option.wrong { border-color: var(--danger); background: rgba(239, 68, 68, 0.2); }

        /* Toast Notification */
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--success); color: white; padding: 12px 24px; border-radius: 30px;
            font-weight: 600; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            width: max-content;
        }
        #toast.show { opacity: 1; bottom: 40px; }

    </style>
</head>
<body>

<div id="loaderOverlay" class="loader-overlay">
    <div class="spinner"></div>
    <div id="loaderText" style="font-weight: 600;">Processing...</div>
</div>

<div id="toast">Session Saved! üíæ</div>

<div class="container">
    <header>
        <h1>ExamReady Mobile</h1>
        <p>Scan, Paste, or Link & Study</p>
    </header>

    <div class="tabs">
        <div class="tab-btn active" onclick="setTab('paste', this)">üìù Paste</div>
        <div class="tab-btn" onclick="setTab('camera', this)">üì∑ Camera</div>
        <div class="tab-btn" onclick="setTab('upload', this)">üìÇ File</div>
        <div class="tab-btn" onclick="setTab('url', this)">üîó Link</div>
    </div>

    <div id="paste" class="input-zone active">
        <textarea id="mainInput" placeholder="Paste text here..."></textarea>
    </div>

    <div id="camera" class="input-zone">
        <div class="camera-wrapper">
            <video id="videoElement" autoplay playsinline muted></video>
            <canvas id="hiddenCanvas" style="display:none"></canvas>
            
            <div class="cam-overlay">
                <button class="cam-btn" onclick="initCamera()">‚ö°</button> 
                <button class="cam-btn snap" onclick="takePicture()"></button>
            </div>
        </div>
        <p style="text-align:center; font-size:0.8rem;">Tap ‚ö° to start, then large circle to snap.</p>
    </div>

    <div id="upload" class="input-zone">
        <div style="border: 2px dashed var(--border); padding: 40px; text-align: center; border-radius: 12px;" onclick="document.getElementById('fileIn').click()">
            <p style="font-size:1.5rem; margin-bottom:5px;">üìÇ</p>
            <strong>Tap to Upload</strong>
            <input type="file" id="fileIn" accept="image/*,.pdf,.txt" hidden onchange="handleFile(this.files[0])">
        </div>
    </div>

    <div id="url" class="input-zone">
        <input type="text" id="urlIn" placeholder="Paste Website URL" style="width:100%; padding:14px; border-radius:10px; border:1px solid var(--border); background:var(--card); color:white; margin-bottom:10px;">
        <button class="btn-full" onclick="handleUrl()">Fetch Content</button>
    </div>

    <div class="actions">
        <button class="btn-full" onclick="analyze()">üöÄ Create Study Plan</button>
        <button class="btn-sec" id="blurBtn" onclick="toggleBlur()" disabled>üëÅÔ∏è Recall</button>
        <button class="btn-sec" id="quizBtn" onclick="startQuiz()" disabled>‚ùì Quiz</button>
        <button class="btn-sec" id="saveBtn" style="grid-column: span 2;" onclick="saveSession()" disabled>üíæ Save Session</button>
    </div>

    <div id="workspace" class="workspace">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <strong style="color:var(--primary)">Study View</strong>
            <span id="modeLabel" style="font-size:0.8rem; background:var(--border); padding:2px 8px; border-radius:4px;">Read</span>
        </div>
        <div id="display" class="content-box"></div>
        <div id="quizArea"></div>
    </div>

    <div class="saved-section">
        <h3>üìÇ Saved Sessions</h3>
        <div id="sessionList"></div>
    </div>

</div>

<script>
    // State
    let stream = null;
    let isBlurred = false;
    let facts = [];

    // --- UI Helpers ---
    function setTab(id, el) {
        document.querySelectorAll('.input-zone').forEach(z => z.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        
        // Stop camera if leaving tab
        if (id !== 'camera' && stream) stopCamera();
    }

    function showLoader(msg) {
        document.getElementById('loaderText').innerText = msg;
        document.getElementById('loaderOverlay').style.display = 'flex';
    }

    function hideLoader() {
        document.getElementById('loaderOverlay').style.display = 'none';
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    // --- 1. Camera Logic (Optimized) ---
    async function initCamera() {
        try {
            const video = document.getElementById('videoElement');
            // 'environment' prefers rear camera on mobile
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
            });
            video.srcObject = stream;
        } catch (err) {
            alert("Camera Error: " + err.message);
        }
    }

    function stopCamera() {
        if(stream) stream.getTracks().forEach(t => t.stop());
        stream = null;
    }

    async function takePicture() {
        if(!stream) return alert("Start camera first");
        
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('hiddenCanvas');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        stopCamera(); // Stop video to save battery/resources
        
        showLoader("Reading Image...");
        
        try {
            const worker = await Tesseract.createWorker();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            const { data } = await worker.recognize(canvas);
            await worker.terminate();
            
            document.getElementById('mainInput').value = data.text;
            hideLoader();
            setTab('paste', document.querySelectorAll('.tab-btn')[0]);
            showToast("Text Extracted!");
        } catch(e) {
            hideLoader();
            alert("OCR Failed: " + e.message);
        }
    }

    // --- 2. File & URL Handlers ---
    async function handleFile(file) {
        if(!file) return;
        showLoader("Processing File...");
        try {
            let txt = "";
            if(file.type === 'application/pdf') {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                for(let i=1; i<=pdf.numPages; i++) {
                    txt += (await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(" ");
                }
            } else if(file.type.startsWith('image/')) {
                const w = await Tesseract.createWorker();
                await w.loadLanguage('eng');
                await w.initialize('eng');
                txt = (await w.recognize(file)).data.text;
                await w.terminate();
            } else {
                txt = await file.text();
            }
            document.getElementById('mainInput').value = txt;
            hideLoader();
            setTab('paste', document.querySelectorAll('.tab-btn')[0]);
        } catch(e) { hideLoader(); alert(e.message); }
    }

    async function handleUrl() {
        const url = document.getElementById('urlIn').value;
        if(!url) return;
        showLoader("Fetching URL...");
        try {
            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
            const data = await res.json();
            const doc = new DOMParser().parseFromString(data.contents, "text/html");
            ['script','style','nav','footer'].forEach(t => doc.querySelectorAll(t).forEach(e=>e.remove()));
            document.getElementById('mainInput').value = doc.body.innerText.replace(/\s+/g,' ').trim();
            hideLoader();
            setTab('paste', document.querySelectorAll('.tab-btn')[0]);
        } catch(e) { hideLoader(); alert("Could not load URL. Try copying text manually."); }
    }

    // --- 3. Core Logic ---
    function analyze() {
        const txt = document.getElementById('mainInput').value;
        if(!txt.trim()) return showToast("Please enter text first!");
        
        facts = [];
        const sentences = txt.match(/[^.!?]+[.!?]+/g) || [txt];
        let html = "";
        
        // Matches Years, Percentages, Capitalized Phrases
        const regex = /(\b(19|20)\d{2}\b|\d+(?:\.\d+)?%|[A-Z][a-z]+(?:\s[A-Z][a-z]+)*)/g;
        
        sentences.forEach(s => {
            let safeS = s;
            safeS = safeS.replace(regex, (m) => {
                if(["The","It","This","That"].includes(m)) return m;
                facts.push({ term: m, context: s, type: isNaN(m) ? 'text' : 'num' });
                return `<span class="term" onclick="reveal(this)">${m}</span>`;
            });
            html += safeS + " ";
        });
        
        document.getElementById('display').innerHTML = html;
        document.getElementById('workspace').style.display = 'block';
        
        // Enable buttons
        ['blurBtn','quizBtn','saveBtn'].forEach(id => document.getElementById(id).disabled = false);
        
        // Scroll to workspace
        document.getElementById('workspace').scrollIntoView({behavior:'smooth'});
    }

    // --- 4. Study Modes ---
    function toggleBlur() {
        isBlurred = !isBlurred;
        const d = document.getElementById('display');
        d.className = isBlurred ? "content-box blur-mode" : "content-box";
        document.getElementById('modeLabel').innerText = isBlurred ? "Recall Mode" : "Read Mode";
        showToast(isBlurred ? "Tap words to reveal" : "Reading Mode Active");
    }

    function reveal(el) {
        if(isBlurred) el.classList.add('revealed');
    }

    function startQuiz() {
        const area = document.getElementById('quizArea');
        area.innerHTML = '<h3 style="margin-top:20px; color:var(--primary)">Quick Quiz</h3>';
        
        if(facts.length < 3) return showToast("Not enough facts for quiz");
        
        // Simple Quiz Logic
        const questions = facts.sort(()=>0.5-Math.random()).slice(0, 3);
        
        questions.forEach((q, i) => {
            const card = document.createElement('div');
            card.className = 'quiz-card';
            
            // Distractors
            let opts = facts.map(f=>f.term).filter(t=>t!==q.term)
                           .sort(()=>0.5-Math.random()).slice(0,3);
            opts.push(q.term);
            opts.sort(()=>0.5-Math.random());
            
            card.innerHTML = `
                <p><strong>Q${i+1}:</strong> ${q.context.replace(q.term, '____')}</p>
                <div>${opts.map(o=>`<button class="option" onclick="check(this,'${o}','${q.term}')">${o}</button>`).join('')}</div>
            `;
            area.appendChild(card);
        });
        
        area.scrollIntoView({behavior:'smooth'});
    }

    function check(btn, sel, corr) {
        const all = btn.parentElement.children;
        for(let b of all) b.disabled=true;
        
        if(sel === corr) {
            btn.classList.add('correct');
        } else {
            btn.classList.add('wrong');
            for(let b of all) if(b.innerText===corr) b.classList.add('correct');
        }
    }

    // --- 5. Save System (Mobile Fixed) ---
    function saveSession() {
        const txt = document.getElementById('mainInput').value;
        if(!txt) return;

        try {
            const sessions = JSON.parse(localStorage.getItem('ER_Sessions') || '[]');
            const newS = { 
                id: Date.now(), 
                title: txt.slice(0, 30) + "...", 
                data: txt, 
                date: new Date().toLocaleDateString() 
            };
            sessions.unshift(newS);
            localStorage.setItem('ER_Sessions', JSON.stringify(sessions));
            loadSessions();
            showToast("Saved to Phone!");
        } catch(e) {
            alert("Save failed: Device storage full or disabled.");
        }
    }

    function loadSessions() {
        const list = document.getElementById('sessionList');
        const s = JSON.parse(localStorage.getItem('ER_Sessions') || '[]');
        
        list.innerHTML = s.map(item => `
            <div class="session-card" onclick="loadOne(${item.id})">
                <div>
                    <strong>${item.title}</strong><br>
                    <small style="color:#64748b">${item.date}</small>
                </div>
                <div class="del-btn" onclick="delOne(event, ${item.id})">√ó</div>
            </div>
        `).join('') || '<p style="text-align:center; color:#64748b">No saved sessions</p>';
    }

    function loadOne(id) {
        const s = JSON.parse(localStorage.getItem('ER_Sessions') || '[]');
        const found = s.find(x => x.id === id);
        if(found) {
            document.getElementById('mainInput').value = found.data;
            analyze();
            setTab('paste', document.querySelectorAll('.tab-btn')[0]);
        }
    }

    function delOne(e, id) {
        e.stopPropagation();
        if(!confirm("Delete?")) return;
        const s = JSON.parse(localStorage.getItem('ER_Sessions') || '[]');
        const left = s.filter(x => x.id !== id);
        localStorage.setItem('ER_Sessions', JSON.stringify(left));
        loadSessions();
    }

    // Init
    loadSessions();

</script>
</body>
</html>
